1. Related-nonce attacks across keys allow root key recovery Severity: Medium Diï¬ƒculty: Undetermined Type: Cryptography Finding ID: TOB-CTSA-1 Target: Root key Description Given multiple addresses generated by the same sender, if any two signatures with the associated private keys use the same nonce, then the recipientâ€™s private root key can be recovered. Nonce reuse attacks are a known risk for single ECDSA keys, but this attack extends the vulnerability to all keys generated by a given sender. Exploit Scenario Alice uses Bobâ€™s public key to generate addresses ğµ 1 = ğ»ğ‘ğ‘ â„ ( ğ‘  ||1 ) * ğº + ğµ ğ‘ğ‘ and ğ‘Ÿğ‘œğ‘œğ‘¡ = ğ»ğ‘ğ‘ â„ ( ğ‘  ||2 ) * ğº + ğµ and deposits funds in each. Bobâ€™s corresponding private ğµ 2 keys will be ğ‘ğ‘ ğ‘ 1 does not know ğ‘Ÿğ‘œğ‘œğ‘¡ ||1 ) + ğ‘ = ğ»ğ‘ğ‘ â„ ( ğ‘  ğ‘ğ‘ ğ‘ 2 ğ‘Ÿğ‘œğ‘œğ‘¡ ğ‘ , she does know the diï¬€erence of the two: 2 = ğ»ğ‘ğ‘ â„ ( ğ‘  ||2 ) + ğ‘ and ğ‘Ÿğ‘œğ‘œğ‘¡ ğ‘ğ‘ ğ‘ 1 or . Note that, while Alice ğ‘ ğ‘‘ğ‘–ğ‘“ğ‘“ = ğ‘ 2 âˆ’ ğ‘ 1 = ğ»ğ‘ğ‘ â„ ( ğ‘  ||2 ) âˆ’ ğ»ğ‘ğ‘ â„ ( ğ‘  ||1 ) ğ‘ğ‘ . As a result, she can write ğ‘ 2 = ğ‘ 1 + ğ‘ . ğ‘‘ğ‘–ğ‘“ğ‘“ ğ‘ğ‘ Suppose Bob signs messages with hashes (respectively), and he uses the same nonce ğ‘š 2 and to transfer the funds out of ğ‘š ğµ 1 2 ğ‘˜ in both signatures. He will output signatures âˆ’ 1 âˆ’ 1 and ğµ 1 ) ( ğ‘Ÿ , ğ‘  1 and ) ( ğ‘Ÿ , ğ‘  2 , where ğ‘Ÿ = ( ğ‘˜ * ğº ) , ğ‘¥ ğ‘  1 = ğ‘˜ ( ğ‘š 1 ) + ğ‘Ÿ ğ‘ 1 , and = ğ‘˜ ğ‘  2 ( ğ‘š 2 + ğ‘Ÿ ğ‘ 1 + ğ‘Ÿ ğ‘ ) ğ‘‘ğ‘–ğ‘“ğ‘“ . ğ‘  Subtracting the -values gives us ğ‘  1 except ğ‘˜ are known, Alice can recover âˆ’ 1 âˆ’ ğ‘  2 ğ‘˜ = ğ‘˜ ( ğ‘š 1 ğ‘ , and thus 1 âˆ’ ğ‘š 2 ğ‘ , and 2 âˆ’ ğ‘Ÿ ğ‘ ) ğ‘‘ğ‘–ğ‘“ğ‘“ ğ‘ ğ‘Ÿğ‘œğ‘œğ‘¡ . Because all the terms = ğ‘ 2 âˆ’ ğ»ğ‘ğ‘ â„ ( ğ‘  ||2 ) . ğ‘ğ‘ Recommendations Consider using deterministic nonce generation in any stealth-enabled wallets. This is an approach used in multiple elliptic curve digital signature schemes, and can be adapted to ECDSA relatively easily; see RFC 6979 . Also consider root key blinding. Set ğµ ğ‘– = ğ»ğ‘ğ‘ â„ ( ğ‘  || ğ‘– ) * ğº + ğ»ğ‘ğ‘ â„ ( ğ‘  || ğ‘– ||" ğ‘Ÿğ‘œğ‘œğ‘¡ " ) * ğµ ğ‘ğ‘ ğ‘ğ‘ With blinding, private keys take the form ğ‘ ğ‘– = ğ»ğ‘ğ‘ â„ ( ğ‘  || ğ‘– ) + ğ‘ Â· ğ»ğ‘ğ‘ â„ ( ğ‘  || ğ‘– ||" ğ‘Ÿğ‘œğ‘œğ‘¡ " ) ğ‘ğ‘ ğ‘ğ‘ Since the ğ‘ ğ‘Ÿğ‘œğ‘œğ‘¡ terms no longer cancel out, Alice cannot ï¬nd , and the attack falls apart. ğ‘Ÿğ‘œğ‘œğ‘¡ ğ‘ ğ‘‘ğ‘–ğ‘“ğ‘“ . ğ‘Ÿğ‘œğ‘œğ‘¡ . Finally, consider using homogeneous key derivation. Set private key for Bob is then ğ‘ ğ‘– = ğ»ğ‘ğ‘ â„ ( ğ‘  || ğ‘– ) Â· ğ‘ + ğ‘ ğ‘ğ‘ ğ·ğ» ğ‘Ÿğ‘œğ‘œğ‘¡ ğµ ğ‘– = ğ»ğ‘ğ‘ â„ ( ğ‘  || ğ‘– ) * ğµ + ğµ ğ‘Ÿğ‘œğ‘œğ‘¡ . Because Alice does not know ğ·ğ» ğ‘ğ‘ . The ğ‘ , ğ‘‘â„ she cannot ï¬nd ğ‘ , and the attack falls apart. ğ‘‘ğ‘–ğ‘“ğ‘“ References â— â— ECDSA: Handle with Care RFC 6979: Deterministic Usage of the Digital Signature Algorithm (DSA) and Elliptic Curve Digital Signature Algorithm (ECDSA) 
2. Limited forgeries for related keys Severity: Low Diï¬ƒculty: Low Type: Cryptography Finding ID: TOB-CTSA-2 Target: Stealth addresses generated by the same sender Description If Bob signs a message for an address generated by Alice, Alice can convert it into a valid signature for another address. She cannot, however, control the hash of the message being signed, so this attack is of limited value. As with the related-nonce attack, this attack relies on Alice knowing the diï¬€erence in discrete logarithms between two addresses. Exploit Scenario Alice generates addresses ğµ 1 = ğ»ğ‘ğ‘ â„ ( ğ‘  ||1 ) * ğº + ğµ ğ‘ğ‘ and ğµ 2 ğ‘Ÿğ‘œğ‘œğ‘¡ = ğ»ğ‘ğ‘ â„ ( ğ‘  ||2 ) * ğº + ğµ ğ‘ğ‘ ğ‘Ÿğ‘œğ‘œğ‘¡ and deposits funds in each account. As before, Alice knows discrete logs for ğµ 1 and ğµ , and 2 ğµ ğ‘‘ğ‘–ğ‘“ğ‘“ = ğµ 2 âˆ’ ğµ . 1 ğ‘ ğ‘‘ğ‘–ğ‘“ğ‘“ , the diï¬€erence of the Bob transfers money out of ğµ , generating signature 2 ğ‘˜ * ğº -coordinate of (where ğ‘˜ where ğ‘Ÿ is the ğ‘¥ ( ğ‘Ÿ , ğ‘  ) of a message ğ‘š ğ‘’ with hash , is the nonce). The signature is validated by computing ğ‘ƒ = ğ‘’ ğ‘  âˆ’ 1 * ğº + ğ‘Ÿ ğ‘  âˆ’ 1 * ğµ 2 and verifying that the ğ‘¥ -coordinate of ğ‘ƒ ğ‘Ÿ matches . Alice can convert this into a signature under for a message with hash ğ‘’ ' = ğ‘’ + ğ‘Ÿ ğ‘ . ğ‘‘ğ‘–ğ‘“ğ‘“ Verifying this signature under ğµ , computing 1 ğµ 1 ğ‘ƒ becomes: ğ‘ƒ = ( ğ‘’ + ğ‘Ÿ ğ‘ âˆ’ 1 ) ğ‘  * ğº + ğ‘Ÿ ğ‘  âˆ’ 1 * ğµ 1 ğ‘‘ğ‘–ğ‘“ğ‘“ âˆ’ 1 = ğ‘’ ğ‘  * ğº + ğ‘Ÿ ğ‘ âˆ’ 1 ğ‘  âˆ’ 1 ğ‘  * ğº + ğ‘Ÿ ğ‘ 1 * ğº ğ‘‘ğ‘–ğ‘“ğ‘“ âˆ’ 1 = ğ‘’ ğ‘  * ğº + ğ‘Ÿ ğ‘  âˆ’ 1 ( ğ‘ 1 + ğ‘ ğ‘‘ğ‘–ğ‘“ğ‘“ ) * ğº âˆ’ 1 = ğ‘’ ğ‘  * ğº + ğ‘Ÿ ğ‘  âˆ’ 1 * ğµ 2 This is the same relation that makes will be correct. ( ğ‘Ÿ , ğ‘  ) a valid signature on a message with hash , so ğ‘’ ğ‘ƒ Note that Alice has no control over the value of ğ‘’ ' would have to ï¬nd a preimage preimages is, to date, a hard problem for SHA-256 and related functions. under the given hash function. Computing , so to make an eï¬€ective exploit, she ğ‘š ' of ğ‘’ ' Recommendations Consider root key blinding, as above. The attack relies on Alice knowing blinding prevents her from learning it. ğ‘ ğ‘‘ğ‘–ğ‘“ğ‘“ , and root key Consider homogeneous key derivation, as above. Once again, depriving Alice of ğ‘ ğ‘‘ğ‘–ğ‘“ğ‘“ obviates the attack completely. 
3. Mutual transactions can be completely deanonymized Severity: Medium Diï¬ƒculty: Medium Type: Cryptography Finding ID: TOB-CTSA-3 Target: Anonymity of mutual transactions Description When Alice and Bob both make stealth payments to each other, they generate the same Shared Secret #i for transaction i, which is used to derive destination keys for Bob and Alice: Symbol Description Aliceâ€™s derivation Bobâ€™s derivation s i B i A i Shared secret #i hash(a dh * B dh , i) hash(b dh * A dh , i) Bobâ€™s destination key #i Aliceâ€™s destination key #i B r + s i * G A r + s i * G However, as a result, the destination keys of Bob and Alice for the same transaction number #i will always have the constant diï¬€erence B i - A i = B r - A r . Exploit Scenario An attacker records all root public keys from the database, computes the pairwise diï¬€erences B i - A i for every pair of users A and B they want to monitor, and stores the diï¬€erences in a list. The attacker subsequently reviews all pairs of public keys associated with transactions on the blockchain, computes the diï¬€erences between the public keys, and compares the x coordinates to the stored list of pairwise diï¬€erences. If a match is found, the attacker knows that those transactions correspond to stealth transactions between A and B with some index i. The attacker can also determine which transaction went from A to B and vice versa by considering the y coordinates of the public keys and pairwise diï¬€erences. Because the attack compromises the anonymity of pairs of users without giving access to funds, we consider this issue to have medium severity. As the attack requires both users in the pair to make transactions to each other, and as it requires a potentially signiï¬cant calculation eï¬€ort (proportional to the square of the number of transactions), we consider this issue to have medium diï¬ƒculty. Recommendations There are several ways to mitigate this issue: â— â— Root key blinding, as described in the recommendations for TOB-CTSA-1 . Diversify the shared secret #i, e.g., by adding the DH key of the receiver to the hash ğ‘  ğ‘– , ğµ ) , or to any other known ğ‘‘â„ ) = ğ»ğ‘ğ‘ â„ ( ğ‘ = ğ»ğ‘ğ‘ â„ ( ğ‘ || ğ‘– || ğµ || ğ‘– || ğµ Â· ğµ Â· ğ´ ğ‘‘â„ ğ‘‘â„ ğ‘‘â„ ğ‘‘â„ ğ‘‘â„ identiï¬er for the receiver (e.g., public root key B r , a unique predetermined string that is stored in the public key database). â— Homogenize the destination keys by including both the root key and the DH key of the receiver, i.e., * ğµ + ğ‘  = ğµ ğµ ğ‘– ğ‘Ÿ ğ‘– ğ‘‘â„ , with corresponding private key ğ‘ ğ‘– = ğ‘ ğ‘Ÿ Â· ğ‘ + ğ‘  ğ‘– . ğ‘‘â„ The advantages and disadvantages of each of these mitigation methods is discussed in detail in Appendix B . 
4. Allowing invalid public keys may enable DH private key recovery Severity: Medium Diï¬ƒculty: High Type: Cryptography Finding ID: TOB-CTSA-4 Target: DH private key Description Consider the following three assumptions: 1. 2. 3. Alice can add points that are not on the elliptic curve to the public key database, Bob does not verify the public key points, and Bob's scalar multiplication implementation has some speciï¬c characteristics. Assumptions 1 and 2 are currently not speciï¬ed in the speciï¬cation, which motivates this ï¬nding. If these assumptions hold, then Alice can recover Bob's DH key using a complicated attack, based on the CRYPTO 2000 paper by Biehl et al. and the DCC 2005 paper by Ciet et al . What follows is a rough sketch of the attack. For more details, see the reference publications, which also detail the speciï¬c characteristics for Assumption 3. Exploit Scenario Alice roughly follows the following steps: 1. Find a point ğ‘ƒ ' which is not on the curve used for ECDH, and a. b. when used in Bobâ€™s scalar multiplication, is eï¬€ectively on a diï¬€erent curve ğ¸ ' 2. 3. 4. with (a subgroup of) small prime order Brute-force all possible values of addresses with shared secret ğ‘¥ Â· ğ‘ƒ ' for ğ»ğ‘ğ‘ â„ ( ğ‘¥ Â· ğ‘ƒ ' || 0 ) the unique stealth address associated with ğ‘ ğ‘‘â„ Â· ğ‘ƒ ' = ( ğ‘ ğ‘šğ‘œğ‘‘ ğ‘ ' ) Â· ğ‘ƒ ' . ğ‘‘â„ ğ‘ ' . 0 â‰¤ ğ‘¥ < ğ‘ ' , i.e., ğµ ğ‘¥ ğ‘¥ ' = ğ‘ ğ‘‘â„ , and sends funds to all + ğ»ğ‘ğ‘ â„ ( ğ‘¥ Â· ğ‘ƒ '|| 0 ) * ğº = ğµ ğµ . ğ‘Ÿ ğ‘¥ ğ‘šğ‘œğ‘‘ ğ‘ ' . This happens because Monitor all resulting addresses associated with until Bob withdraws funds from Repeat steps 1â€“3 for new points ' ğ‘ƒ ğ‘— with diï¬€erent small prime orders ' ğ‘ ğ‘— to recover ğ‘ ' ğ‘šğ‘œğ‘‘ ğ‘ . ğ‘— ğ‘‘â„ 5. Use the Chinese Remainder Theorem to recover ğ‘ ğ‘‘â„ from ğ‘ ğ‘‘â„ ' ğ‘šğ‘œğ‘‘ ğ‘ . ğ‘— As a result, Alice can now track all stealth payments made to Bob (but cannot steal funds). To understand the complexity of this attack, it is suï¬ƒcient for Alice to repeat steps 1â€“3 for the ï¬rst 44 primes (numbers between 2 and 193). This requires Alice to make 3,831 payments in total (corresponding to the sum of the ï¬rst 44 primes). There is a tradeoï¬€ where Alice uses fewer primes, which means that fewer transactions are needed. However, it means that Alice does not recover the full b dh . To compensate for this, Alice can brute-force the discrete logarithm of B dh guided by the partial information on b dh . Because the attack compromises anonymity for a particular user without giving access to funds, we consider this issue to have medium severity. As this is a complicated attack with various assumptions that requires Bob to access the funds from all his stealth addresses, we consider this issue to have high diï¬ƒculty. Recommendations The speciï¬cation should enforce that public keys are validated for correctness, both when they are added to the public database and when they are used by senders and receivers. These validations should include point-on-curve checks, small-order-subgroup checks (if applicable), and point-at-inï¬nity checks. References â— â— Diï¬€erential Fault Attacks on Elliptic Curve Cryptosystems, Biehl et al., 2000 Elliptic Curve Cryptosystems in the Presence of Permanent and Transient Faults, Ciet et al., 
